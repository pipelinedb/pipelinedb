SET debug_sync_stream_insert = 'on';
CREATE CONTINUOUS VIEW test_count AS SELECT k::text, COUNT(*) FROM stream WHERE arrival_timestamp > clock_timestamp() - interval '5 hour' GROUP BY k;
ACTIVATE test_count;
INSERT INTO stream (k) VALUES ('x'), ('x'), ('x'), ('x'), ('x'), ('x');
INSERT INTO stream (k) VALUES ('x'), ('x'), ('x'), ('x'), ('x'), ('x'), ('y'), ('y'), ('y'), ('y'), ('y'), ('y');
DEACTIVATE;
SELECT k, count FROM test_count_pdb ORDER BY k;
 k | count 
---+-------
 x |    12
 y |     6
(2 rows)

SELECT * FROM test_count ORDER BY k;
 k | count 
---+-------
 x |    12
 y |     6
(2 rows)

ACTIVATE test_count;
SELECT pg_sleep(1);
 pg_sleep 
----------
 
(1 row)

INSERT INTO stream (k) VALUES ('x'), ('x'), ('x'), ('x'), ('x'), ('x');
INSERT INTO stream (k) VALUES ('x'), ('x'), ('x'), ('x'), ('x'), ('x'), ('y'), ('y'), ('y'), ('y'), ('y'), ('y');
DEACTIVATE;
SELECT k, count FROM test_count_pdb ORDER BY k;
 k | count 
---+-------
 x |    12
 x |    12
 y |     6
 y |     6
(4 rows)

SELECT * FROM test_count ORDER BY k;
 k | count 
---+-------
 x |    24
 y |    12
(2 rows)

DROP CONTINUOUS VIEW test_count;

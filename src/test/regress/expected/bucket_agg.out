CREATE STREAM bucket_stream (x integer, y integer, z text);
CREATE CONTINUOUS VIEW bucket0 AS SELECT bucket_agg(x, y::smallint) FROM bucket_stream;
INSERT INTO bucket_stream (x, y) VALUES (0, 0);
SELECT bucket_ids(bucket_agg), bucket_cardinalities(bucket_agg) FROM bucket0;
 bucket_ids | bucket_cardinalities 
------------+----------------------
 {0}        | {1}
(1 row)

-- Move element 0 into bucket 1
INSERT INTO bucket_stream (x, y) VALUES (0, 1);
SELECT bucket_ids(bucket_agg), bucket_cardinalities(bucket_agg) FROM bucket0;
 bucket_ids | bucket_cardinalities 
------------+----------------------
 {1}        | {1}
(1 row)

-- Now add a new element to the empty bucket 0
INSERT INTO bucket_stream (x, y) VALUES (1, 0);
SELECT bucket_ids(bucket_agg), bucket_cardinalities(bucket_agg) FROM bucket0;
 bucket_ids | bucket_cardinalities 
------------+----------------------
 {1,0}      | {1,1}
(1 row)

INSERT INTO bucket_stream (x, y) SELECT generate_series(2, 10), 2;
SELECT bucket_ids(bucket_agg), bucket_cardinalities(bucket_agg) FROM bucket0;
 bucket_ids | bucket_cardinalities 
------------+----------------------
 {1,0,2}    | {1,1,9}
(1 row)

DROP CONTINUOUS VIEW bucket0;
CREATE CONTINUOUS VIEW bucket1 AS SELECT bucket_agg(x, y::smallint) FROM bucket_stream;
INSERT INTO bucket_stream (x, y) SELECT x, x % 10 AS y FROM generate_series(1, 10000) AS x;
SELECT bucket_ids(bucket_agg) FROM bucket1;
      bucket_ids       
-----------------------
 {1,2,3,4,5,6,7,8,9,0}
(1 row)

SELECT bucket_cardinalities(bucket_agg) FROM bucket1;
                bucket_cardinalities                 
-----------------------------------------------------
 {1000,1000,1000,1000,1000,1000,1000,1000,1000,1000}
(1 row)

INSERT INTO bucket_stream (x, y) SELECT x % 2, 11 AS y FROM generate_series(1, 10000) AS x;
SELECT bucket_ids(bucket_agg) FROM bucket1;
        bucket_ids        
--------------------------
 {11,2,3,4,5,6,7,8,9,0,1}
(1 row)

SELECT bucket_cardinalities(bucket_agg) FROM bucket1;
                 bucket_cardinalities                 
------------------------------------------------------
 {2,1000,1000,1000,1000,1000,1000,1000,1000,1000,999}
(1 row)

DROP CONTINUOUS VIEW bucket1;
CREATE CONTINUOUS VIEW bucket2 AS SELECT x % 10 AS g, bucket_agg(z, y::smallint) FROM bucket_stream GROUP BY g;
INSERT INTO bucket_stream (x, y, z) SELECT x % 4, x % 10, lpad(x::text, 32, '0')  FROM generate_series(1, 10000) AS x;
SELECT g, bucket_ids(bucket_agg), bucket_cardinalities(bucket_agg) FROM bucket2 ORDER BY g;
 g | bucket_ids  | bucket_cardinalities  
---+-------------+-----------------------
 0 | {4,8,2,6,0} | {500,500,500,500,500}
 1 | {1,5,9,3,7} | {500,500,500,500,500}
 2 | {2,6,0,4,8} | {500,500,500,500,500}
 3 | {3,7,1,5,9} | {500,500,500,500,500}
(4 rows)

INSERT INTO bucket_stream (x, y, z) SELECT x % 4, 11, lpad((x % 2)::text, 32, '0') AS y FROM generate_series(1, 10000) AS x;
SELECT g, bucket_ids(bucket_agg), bucket_cardinalities(bucket_agg) FROM bucket2 ORDER BY g;
 g |   bucket_ids   |  bucket_cardinalities   
---+----------------+-------------------------
 0 | {4,8,2,6,0,11} | {500,500,500,500,500,1}
 1 | {11,5,9,3,7,1} | {1,500,500,500,500,499}
 2 | {2,6,0,4,8,11} | {500,500,500,500,500,1}
 3 | {3,7,1,5,9,11} | {500,500,500,500,500,1}
(4 rows)

-- Now let's run some user combines on them
SELECT g % 2 as x, bucket_ids(combine(bucket_agg)), bucket_cardinalities(combine(bucket_agg))
FROM bucket2 GROUP BY x ORDER BY x;
 x |   bucket_ids   |     bucket_cardinalities     
---+----------------+------------------------------
 0 | {4,8,2,6,0,11} | {1000,1000,1000,1000,1000,1}
 1 | {11,5,9,3,7,1} | {1,1000,1000,1000,1000,999}
(2 rows)

SELECT bucket_cardinality(combine(bucket_agg), 1::smallint) FROM bucket2;
 bucket_cardinality 
--------------------
                999
(1 row)

SELECT bucket_cardinality(combine(bucket_agg), 2::smallint) FROM bucket2;
 bucket_cardinality 
--------------------
               1000
(1 row)

SELECT bucket_cardinality(combine(bucket_agg), 4::smallint) FROM bucket2;
 bucket_cardinality 
--------------------
               1000
(1 row)

SELECT bucket_cardinality(combine(bucket_agg), 8::smallint) FROM bucket2;
 bucket_cardinality 
--------------------
               1000
(1 row)

INSERT INTO bucket_stream (x, y, z) VALUES (3, 8::smallint, 'unique');
SELECT g, bucket_ids(combine(bucket_agg)), bucket_cardinalities(combine(bucket_agg)) FROM bucket2
GROUP BY g ORDER BY g;
 g |    bucket_ids    |   bucket_cardinalities    
---+------------------+---------------------------
 0 | {4,8,2,6,0,11}   | {500,500,500,500,500,1}
 1 | {11,5,9,3,7,1}   | {1,500,500,500,500,499}
 2 | {2,6,0,4,8,11}   | {500,500,500,500,500,1}
 3 | {3,7,1,5,9,11,8} | {500,500,500,500,500,1,1}
(4 rows)

INSERT INTO bucket_stream (x, y, z) VALUES (9, 8::smallint, 'unique');
INSERT INTO bucket_stream (x, y, z) VALUES (9, 8::smallint, 'unique1');
INSERT INTO bucket_stream (x, y, z) VALUES (9, 8::smallint, 'unique2');
SELECT g, bucket_ids(combine(bucket_agg)), bucket_cardinalities(combine(bucket_agg)) FROM bucket2
GROUP BY g ORDER BY g;
 g |    bucket_ids    |   bucket_cardinalities    
---+------------------+---------------------------
 0 | {4,8,2,6,0,11}   | {500,500,500,500,500,1}
 1 | {11,5,9,3,7,1}   | {1,500,500,500,500,499}
 2 | {2,6,0,4,8,11}   | {500,500,500,500,500,1}
 3 | {3,7,1,5,9,11,8} | {500,500,500,500,500,1,1}
 9 | {8}              | {3}
(5 rows)

DROP CONTINUOUS VIEW bucket2;
DROP STREAM bucket_stream;

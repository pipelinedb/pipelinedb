CREATE FOREIGN TABLE test_topk_agg_stream (x float8, y int, k text, t text) SERVER pipelinedb;
CREATE VIEW test_topk_agg0 AS SELECT k::text, topk_agg(x::int, 3) FROM test_topk_agg_stream GROUP BY k;
CREATE VIEW test_topk_agg1 AS SELECT k::text, topk_agg(x::float8, 3) FROM test_topk_agg_stream GROUP BY k;
CREATE VIEW test_topk_agg2 AS SELECT k::text, topk_agg(k::text, 3) FROM test_topk_agg_stream GROUP BY k;
INSERT INTO test_topk_agg_stream (k, x) VALUES ('a', 1);
INSERT INTO test_topk_agg_stream (k, x) VALUES ('a', 2);
INSERT INTO test_topk_agg_stream (k, x) VALUES ('a', 3);
INSERT INTO test_topk_agg_stream (k, x) VALUES ('a', 1);
INSERT INTO test_topk_agg_stream (k, x) VALUES ('a', 2);
INSERT INTO test_topk_agg_stream (k, x) VALUES ('a', 1);
INSERT INTO test_topk_agg_stream (k, x) VALUES ('b', 4.0);
INSERT INTO test_topk_agg_stream (k, x) VALUES ('b', 5.0);
INSERT INTO test_topk_agg_stream (k, x) VALUES ('b', 3.0);
INSERT INTO test_topk_agg_stream (k, x) VALUES ('b', 3.0);
INSERT INTO test_topk_agg_stream (k, x) VALUES ('b', 4.0);
INSERT INTO test_topk_agg_stream (k, x) VALUES ('b', 4.0);
INSERT INTO test_topk_agg_stream (k, x) VALUES ('b', 3.0);
SELECT k, topk(topk_agg) FROM test_topk_agg0 ORDER BY k;
 k | topk  
---+-------
 a | (1,3)
 a | (2,2)
 a | (3,1)
 b | (4,3)
 b | (3,3)
 b | (5,1)
(6 rows)

SELECT k, topk(topk_agg) FROM test_topk_agg1 ORDER BY k;
 k | topk  
---+-------
 a | (1,3)
 a | (2,2)
 a | (3,1)
 b | (4,3)
 b | (3,3)
 b | (5,1)
(6 rows)

SELECT k, topk_values(topk_agg) FROM test_topk_agg0 ORDER BY k;
 k | topk_values 
---+-------------
 a | {1,2,3}
 b | {4,3,5}
(2 rows)

SELECT k, topk_freqs(topk_agg) FROM test_topk_agg0 ORDER BY k;
 k | topk_freqs 
---+------------
 a | {3,2,1}
 b | {3,3,1}
(2 rows)

SELECT topk(combine(topk_agg)) FROM test_topk_agg0;
 topk  
-------
 (3,4)
 (1,3)
 (4,3)
(3 rows)

SELECT topk(combine(topk_agg)) FROM test_topk_agg1;
 topk  
-------
 (3,4)
 (1,3)
 (4,3)
(3 rows)

DROP VIEW test_topk_agg0;
DROP VIEW test_topk_agg1;
DROP VIEW test_topk_agg2;
CREATE VIEW test_topk_agg3 AS SELECT topk_agg(x::integer, 3, y::integer) AS topk_agg_weighted FROM test_topk_agg_stream;
INSERT INTO test_topk_agg_stream (x, y) VALUES (0, 10);
INSERT INTO test_topk_agg_stream (x, y) VALUES (0, 10);
SELECT topk(topk_agg_weighted) FROM test_topk_agg3;
  topk  
--------
 (0,20)
(1 row)

INSERT INTO test_topk_agg_stream (x, y) VALUES (2, 1);
INSERT INTO test_topk_agg_stream (x, y) VALUES (2, 1);
SELECT topk(topk_agg_weighted) FROM test_topk_agg3;
  topk  
--------
 (0,20)
 (2,2)
(2 rows)

INSERT INTO test_topk_agg_stream (x, y) VALUES (3, 1);
INSERT INTO test_topk_agg_stream (x, y) VALUES (3, 1);
SELECT topk(topk_agg_weighted) FROM test_topk_agg3;
  topk  
--------
 (0,20)
 (2,2)
 (3,2)
(3 rows)

INSERT INTO test_topk_agg_stream (x, y) VALUES (4, 1);
INSERT INTO test_topk_agg_stream (x, y) VALUES (4, 10);
SELECT topk(topk_agg_weighted) FROM test_topk_agg3;
  topk  
--------
 (0,20)
 (4,11)
 (2,2)
(3 rows)

INSERT INTO test_topk_agg_stream (x, y) VALUES (5, 500);
INSERT INTO test_topk_agg_stream (x, y) VALUES (6, 1000);
INSERT INTO test_topk_agg_stream (x, y) VALUES (7, 10000);
INSERT INTO test_topk_agg_stream (x, y) VALUES (8, 10000);
INSERT INTO test_topk_agg_stream (x, y) VALUES (8, 10000);
SELECT topk(topk_agg_weighted) FROM test_topk_agg3;
   topk    
-----------
 (8,20000)
 (7,10000)
 (6,1000)
(3 rows)

CREATE VIEW test_topk_agg4 AS SELECT topk_agg(t::text, 4, y::integer) AS topk_agg_weighted FROM test_topk_agg_stream;
INSERT INTO test_topk_agg_stream (t, y) VALUES ('xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx', 100);
INSERT INTO test_topk_agg_stream (t, y) VALUES ('xxxx', 200);
INSERT INTO test_topk_agg_stream (t, y) VALUES ('yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy', 500);
INSERT INTO test_topk_agg_stream (t, y) VALUES ('yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy', 500);
INSERT INTO test_topk_agg_stream (t, y) VALUES ('xxxxxxxxxxxxxxxxxxxxx', 500);
SELECT topk_values(topk_agg_weighted) FROM test_topk_agg4;
                                                   topk_values                                                   
-----------------------------------------------------------------------------------------------------------------
 {yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy,xxxxxxxxxxxxxxxxxxxxx,xxxx,xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx}
(1 row)

SELECT topk_freqs(topk_agg_weighted) FROM test_topk_agg4;
     topk_freqs     
--------------------
 {1000,500,200,100}
(1 row)

DROP VIEW test_topk_agg3;
DROP VIEW test_topk_agg4;
CREATE VIEW test_topk_agg5 AS SELECT topk_agg(x::integer, 4) FROM test_topk_agg_stream;
INSERT INTO test_topk_agg_stream (x) VALUES (null);
INSERT INTO test_topk_agg_stream (x) VALUES (null);
INSERT INTO test_topk_agg_stream (x) VALUES (null);
INSERT INTO test_topk_agg_stream (x) VALUES (0);
INSERT INTO test_topk_agg_stream (x) VALUES (0);
INSERT INTO test_topk_agg_stream (x) VALUES (1);
INSERT INTO test_topk_agg_stream (x) VALUES (null);
SELECT topk(topk_agg) FROM test_topk_agg5;
 topk  
-------
 (0,2)
 (1,1)
(2 rows)

DROP VIEW test_topk_agg5;
DROP FOREIGN TABLE test_topk_agg_stream CASCADE;
CREATE FOREIGN TABLE hashed_s (x integer, y integer) SERVER pipelinedb;
-- hashed_topk_agg
CREATE VIEW test_hashed_topk_agg0 AS
 SELECT x, hashed_topk_agg(y, 20, 1) FROM hashed_s GROUP BY x;
INSERT INTO hashed_s (x, y) SELECT x % 4, x AS y FROM generate_series(1, 100) x;
INSERT INTO hashed_s (x, y) SELECT 0, 11 AS y FROM generate_series(1, 1000) x;
INSERT INTO hashed_s (x, y) SELECT 1, 22 AS y FROM generate_series(1, 1000) x;
INSERT INTO hashed_s (x, y) SELECT 2, 33 AS y FROM generate_series(1, 1000) x;
INSERT INTO hashed_s (x, y) SELECT 3, 44 AS y FROM generate_series(1, 1000) x;
SELECT x, topk(hashed_topk_agg) FROM test_hashed_topk_agg0 ORDER BY x;
 x |   topk    
---+-----------
 0 | (11,1000)
 0 | (16,1)
 0 | (60,1)
 0 | (72,1)
 0 | (96,1)
 0 | (4,1)
 0 | (52,1)
 0 | (64,1)
 0 | (80,1)
 0 | (76,1)
 0 | (28,1)
 0 | (12,1)
 0 | (24,1)
 0 | (100,1)
 0 | (56,1)
 0 | (44,1)
 0 | (92,1)
 0 | (40,1)
 0 | (84,1)
 0 | (32,1)
 1 | (22,1000)
 1 | (65,1)
 1 | (81,1)
 1 | (89,1)
 1 | (33,1)
 1 | (61,1)
 1 | (77,1)
 1 | (13,1)
 1 | (69,1)
 1 | (37,1)
 1 | (9,1)
 1 | (85,1)
 1 | (25,1)
 1 | (1,1)
 1 | (57,1)
 1 | (97,1)
 1 | (41,1)
 1 | (17,1)
 1 | (49,1)
 1 | (53,1)
 2 | (33,1000)
 2 | (26,1)
 2 | (74,1)
 2 | (82,1)
 2 | (78,1)
 2 | (22,1)
 2 | (62,1)
 2 | (46,1)
 2 | (58,1)
 2 | (14,1)
 2 | (70,1)
 2 | (34,1)
 2 | (6,1)
 2 | (94,1)
 2 | (54,1)
 2 | (66,1)
 2 | (18,1)
 2 | (90,1)
 2 | (42,1)
 2 | (10,1)
 3 | (44,1000)
 3 | (59,1)
 3 | (15,1)
 3 | (47,1)
 3 | (55,1)
 3 | (67,1)
 3 | (11,1)
 3 | (75,1)
 3 | (63,1)
 3 | (43,1)
 3 | (71,1)
 3 | (3,1)
 3 | (35,1)
 3 | (39,1)
 3 | (19,1)
 3 | (83,1)
 3 | (23,1)
 3 | (51,1)
 3 | (7,1)
 3 | (79,1)
(80 rows)

SELECT topk(combine(hashed_topk_agg)) FROM test_hashed_topk_agg0;
   topk    
-----------
 (44,1001)
 (11,1001)
 (22,1001)
 (33,1001)
 (64,1)
 (80,1)
 (76,1)
 (28,1)
 (12,1)
 (24,1)
 (100,1)
 (56,1)
 (92,1)
 (40,1)
 (84,1)
 (32,1)
 (88,1)
 (20,1)
 (68,1)
 (8,1)
(20 rows)

SELECT x % 2 AS g, topk(combine(hashed_topk_agg)) FROM test_hashed_topk_agg0 GROUP BY g ORDER BY g;
 g |   topk    
---+-----------
 0 | (33,1000)
 0 | (11,1000)
 0 | (60,1)
 0 | (72,1)
 0 | (96,1)
 0 | (4,1)
 0 | (52,1)
 0 | (64,1)
 0 | (80,1)
 0 | (76,1)
 0 | (28,1)
 0 | (12,1)
 0 | (24,1)
 0 | (100,1)
 0 | (56,1)
 0 | (44,1)
 0 | (92,1)
 0 | (40,1)
 0 | (84,1)
 0 | (32,1)
 1 | (44,1000)
 1 | (22,1000)
 1 | (81,1)
 1 | (89,1)
 1 | (33,1)
 1 | (61,1)
 1 | (77,1)
 1 | (13,1)
 1 | (69,1)
 1 | (37,1)
 1 | (9,1)
 1 | (85,1)
 1 | (25,1)
 1 | (1,1)
 1 | (57,1)
 1 | (97,1)
 1 | (41,1)
 1 | (17,1)
 1 | (49,1)
 1 | (53,1)
(40 rows)


SET debug_sync_stream_insert = 'on';
-------------------------------------------------------------------------------
-- Integer sums
CREATE CONTINUOUS VIEW test_sw_int8_sum AS SELECT k::text, SUM(v::int8) FROM int_stream WHERE arrival_timestamp > clock_timestamp() - interval '5 hour' GROUP BY k;
CREATE CONTINUOUS VIEW test_sw_int4_sum AS SELECT k::text, SUM(v::int4) FROM int_stream WHERE arrival_timestamp > clock_timestamp() - interval '5 hour' GROUP BY k;
CREATE CONTINUOUS VIEW test_sw_int2_sum AS SELECT k::text, SUM(v::int2) FROM int_stream WHERE arrival_timestamp > clock_timestamp() - interval '5 hour' GROUP BY k;
ACTIVATE test_sw_int8_sum, test_sw_int4_sum, test_sw_int2_sum;
INSERT INTO int_stream (k, v) VALUES ('x', 10), ('x', 10), ('x', 10);
INSERT INTO int_stream (k, v) VALUES ('y', 10), ('y', 10), ('y', 10);
DEACTIVATE;
SELECT k, sum, _1 FROM test_sw_int8_sum_pdb ORDER BY k;
 k | sum |                                                                _1                                                                
---+-----+----------------------------------------------------------------------------------------------------------------------------------
 x |  30 | \x000000000000000003000000000000000000000003000000000000000000000001000000000000000000000000001e00000000000000000000000000000000
 y |  30 | \x000000000000000003000000000000000000000003000000000000000000000001000000000000000000000000001e00000000000000000000000000000000
(2 rows)

SELECT * FROM test_sw_int8_sum ORDER BY k;
 k | sum 
---+-----
 x |  30
 y |  30
(2 rows)

SELECT k, sum FROM test_sw_int4_sum_pdb ORDER BY k;
 k | sum 
---+-----
 x |  30
 y |  30
(2 rows)

SELECT * FROM test_sw_int4_sum ORDER BY k;
 k | sum 
---+-----
 x |  30
 y |  30
(2 rows)

SELECT k, sum FROM test_sw_int2_sum_pdb ORDER BY k;
 k | sum 
---+-----
 x |  30
 y |  30
(2 rows)

SELECT * FROM test_sw_int2_sum ORDER BY k;
 k | sum 
---+-----
 x |  30
 y |  30
(2 rows)

ACTIVATE test_sw_int8_sum, test_sw_int4_sum, test_sw_int2_sum;
SELECT pg_sleep(1);
 pg_sleep 
----------
 
(1 row)

INSERT INTO int_stream (k, v) VALUES ('x', 1), ('x', 2), ('x', 3);
INSERT INTO int_stream (k, v) VALUES ('y', 10), ('y', 10), ('z', 10);
DEACTIVATE;
SELECT k, sum, _1 FROM test_sw_int8_sum_pdb ORDER BY k;
 k | sum |                                                                _1                                                                
---+-----+----------------------------------------------------------------------------------------------------------------------------------
 x |  30 | \x000000000000000003000000000000000000000003000000000000000000000001000000000000000000000000001e00000000000000000000000000000000
 x |   6 | \x000000000000000003000000000000000000000003000000000000000000000001000000000000000000000000000600000000000000000000000000000000
 y |  30 | \x000000000000000003000000000000000000000003000000000000000000000001000000000000000000000000001e00000000000000000000000000000000
 y |  20 | \x000000000000000002000000000000000000000002000000000000000000000001000000000000000000000000001400000000000000000000000000000000
 z |  10 | \x000000000000000001000000000000000000000001000000000000000000000001000000000000000000000000000a00000000000000000000000000000000
(5 rows)

SELECT * FROM test_sw_int8_sum ORDER BY k;
 k | sum 
---+-----
 x |  36
 y |  50
 z |  10
(3 rows)

SELECT k, sum FROM test_sw_int4_sum_pdb ORDER BY k;
 k | sum 
---+-----
 x |  30
 x |   6
 y |  30
 y |  20
 z |  10
(5 rows)

SELECT * FROM test_sw_int4_sum ORDER BY k;
 k | sum 
---+-----
 x |  36
 y |  50
 z |  10
(3 rows)

SELECT k, sum FROM test_sw_int2_sum_pdb ORDER BY k;
 k | sum 
---+-----
 x |  30
 x |   6
 y |  30
 y |  20
 z |  10
(5 rows)

SELECT * FROM test_sw_int2_sum ORDER BY k;
 k | sum 
---+-----
 x |  36
 y |  50
 z |  10
(3 rows)

-------------------------------------------------------------------------------
-- Float sums
CREATE CONTINUOUS VIEW test_sw_float8_sum AS SELECT k::text, SUM(v::float8) FROM float_stream WHERE arrival_timestamp > clock_timestamp() - interval '5 hour' GROUP BY k;
CREATE CONTINUOUS VIEW test_sw_float4_sum AS SELECT k::text, SUM(v::float4) FROM float_stream WHERE arrival_timestamp > clock_timestamp() - interval '5 hour' GROUP BY k;
ACTIVATE test_sw_float8_sum, test_sw_float4_sum;
INSERT INTO float_stream (k, v) VALUES ('x', 10.2), ('x', 1.2), ('x', 0.000001);
INSERT INTO float_stream (k, v) VALUES ('y', -10.3), ('y', 1.2e6), ('y', '100.4');
DEACTIVATE;
SELECT k, sum FROM test_sw_float8_sum_pdb ORDER BY k;
 k |    sum    
---+-----------
 x | 11.400001
 y | 1200090.1
(2 rows)

SELECT * FROM test_sw_float8_sum ORDER BY k;
 k |    sum    
---+-----------
 x | 11.400001
 y | 1200090.1
(2 rows)

SELECT k, sum FROM test_sw_float4_sum_pdb ORDER BY k;
 k |     sum     
---+-------------
 x |        11.4
 y | 1.20009e+06
(2 rows)

SELECT * FROM test_sw_float4_sum ORDER BY k;
 k |     sum     
---+-------------
 x |        11.4
 y | 1.20009e+06
(2 rows)

ACTIVATE test_sw_float8_sum, test_sw_float4_sum;
SELECT pg_sleep(1);
 pg_sleep 
----------
 
(1 row)

INSERT INTO float_stream (k, v) VALUES ('x', 10.2), ('x', 1.2), ('x', 1.2e-4);
INSERT INTO float_stream (k, v) VALUES ('y', -10.3), ('y', 1.2e6), ('y', '100.4');
DEACTIVATE;
SELECT k, sum FROM test_sw_float8_sum_pdb ORDER BY k;
 k |    sum    
---+-----------
 x | 11.400001
 x |  11.40012
 y | 1200090.1
 y | 1200090.1
(4 rows)

SELECT * FROM test_sw_float8_sum ORDER BY k;
 k |    sum    
---+-----------
 x | 22.800121
 y | 2400180.2
(2 rows)

SELECT k, sum FROM test_sw_float4_sum_pdb ORDER BY k;
 k |     sum     
---+-------------
 x |        11.4
 x |     11.4001
 y | 1.20009e+06
 y | 1.20009e+06
(4 rows)

SELECT * FROM test_sw_float4_sum ORDER BY k;
 k |     sum     
---+-------------
 x |     22.8001
 y | 2.40018e+06
(2 rows)

-------------------------------------------------------------------------------
-- Cash sums
CREATE CONTINUOUS VIEW test_sw_cash_sum AS SELECT k::text, SUM(v::money) FROM cash_stream WHERE arrival_timestamp > clock_timestamp() - interval '5 hour' GROUP BY k;
ACTIVATE test_sw_cash_sum;
INSERT INTO cash_stream (k, v) VALUES ('x', 10.2), ('x', 1.2), ('x', 0.10);
INSERT INTO cash_stream (k, v) VALUES ('y', -10), ('y', 10), ('y', 0);
DEACTIVATE;
SELECT k, sum FROM test_sw_cash_sum_pdb ORDER BY k;
 k |  sum   
---+--------
 x | $11.50
 y |  $0.00
(2 rows)

SELECT * FROM test_sw_cash_sum ORDER BY k;
 k |  sum   
---+--------
 x | $11.50
 y |  $0.00
(2 rows)

ACTIVATE test_sw_cash_sum;
SELECT pg_sleep(1);
 pg_sleep 
----------
 
(1 row)

INSERT INTO cash_stream (k, v) VALUES ('x', '500.50');
INSERT INTO cash_stream (k, v) VALUES ('y', '0.01');
DEACTIVATE;
SELECT k, sum FROM test_sw_cash_sum_pdb ORDER BY k;
 k |   sum   
---+---------
 x |  $11.50
 x | $500.50
 y |   $0.00
 y |   $0.01
(4 rows)

SELECT * FROM test_sw_cash_sum ORDER BY k;
 k |   sum   
---+---------
 x | $512.00
 y |   $0.01
(2 rows)

-------------------------------------------------------------------------------
-- Numeric sums
CREATE CONTINUOUS VIEW test_sw_numeric_sum AS SELECT k::text, SUM(v::numeric) FROM numeric_stream WHERE arrival_timestamp > clock_timestamp() - interval '5 hour' GROUP BY k;
ACTIVATE test_sw_numeric_sum;
INSERT INTO numeric_stream (k, v) VALUES ('x', 10.0002), ('x', 0.0001), ('x', -0.10);
INSERT INTO numeric_stream (k, v) VALUES ('y', 1.004e5), ('y', 0.4), ('y', 0);
DEACTIVATE;
SELECT k, sum, _1 FROM test_sw_numeric_sum_pdb ORDER BY k;
 k |   sum    |                                                                    _1                                                                    
---+----------+------------------------------------------------------------------------------------------------------------------------------------------
 x |   9.9003 | \x0000000000000000030000000400000000000000020000000000000000000000020000000000000000000000040009232b00000000000000000000000000000000
 y | 100400.4 | \x000000000000000003000000010000000000000001000000000000000000000003000000010000000000000001000a01900fa000000000000000000000000000000000
(2 rows)

SELECT * FROM test_sw_numeric_sum ORDER BY k;
 k |   sum    
---+----------
 x |   9.9003
 y | 100400.4
(2 rows)

ACTIVATE test_sw_numeric_sum;
SELECT pg_sleep(1);
 pg_sleep 
----------
 
(1 row)

INSERT INTO numeric_stream (k, v) VALUES ('x', '10000000000000000000000000000000000000000000000000000');
INSERT INTO numeric_stream (k, v) VALUES ('y', '-0000000000000000000000000000000000000.00000000000000000000000000000000001');
DEACTIVATE;
SELECT k, sum, _1 FROM test_sw_numeric_sum_pdb ORDER BY k;
 k |                          sum                          |                                                                    _1                                                                    
---+-------------------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------
 x |                                                9.9003 | \x0000000000000000030000000400000000000000020000000000000000000000020000000000000000000000040009232b00000000000000000000000000000000
 x | 10000000000000000000000000000000000000000000000000000 | \x0000000000000000010000000000000000000000010000000000000000000000010000000d0000000000000000000100000000000000000000000000000000
 y |                                              100400.4 | \x000000000000000003000000010000000000000001000000000000000000000003000000010000000000000001000a01900fa000000000000000000000000000000000
 y |                -0.00000000000000000000000000000000001 | \x000000000000000001000000230000000000000001000000000000000000000001fffffff70000400000000023000a00000000000000000000000000000000
(4 rows)

SELECT * FROM test_sw_numeric_sum ORDER BY k;
 k |                            sum                             
---+------------------------------------------------------------
 x | 10000000000000000000000000000000000000000000000000009.9003
 y |                 100400.39999999999999999999999999999999999
(2 rows)

-------------------------------------------------------------------------------
-- Interval sum
CREATE CONTINUOUS VIEW test_sw_interval_sum AS SELECT k::text, SUM(ts1::timestamp - ts0::timestamp) FROM interval_stream WHERE arrival_timestamp > clock_timestamp() - interval '5 hour' GROUP BY k;
ACTIVATE test_sw_interval_sum;
INSERT INTO interval_stream (k, ts0, ts1) VALUES ('x', '2014-01-01', '2014-01-02'), ('x', '2014-01-01', '2014-02-01');
INSERT INTO interval_stream (k, ts0, ts1) VALUES ('x', '2014-01-01', '2014-01-02'), ('x', '2014-01-01', '2014-02-01');
DEACTIVATE;
SELECT k, sum FROM test_sw_interval_sum_pdb ORDER BY k;
 k |    sum    
---+-----------
 x | @ 64 days
(1 row)

SELECT * FROM test_sw_interval_sum ORDER BY k;
 k |    sum    
---+-----------
 x | @ 64 days
(1 row)

ACTIVATE test_sw_interval_sum;
SELECT pg_sleep(1);
 pg_sleep 
----------
 
(1 row)

INSERT INTO interval_stream (k, ts0, ts1) VALUES ('x', '2014-12-31', '2015-01-01'), ('x', '2015-02-28', '2015-03-01');
INSERT INTO interval_stream (k, ts0, ts1) VALUES ('y', '2014-01-01', '2014-01-02'), ('z', '2014-01-01', '2014-02-01');
DEACTIVATE;
SELECT k, sum FROM test_sw_interval_sum_pdb ORDER BY k;
 k |    sum    
---+-----------
 x | @ 64 days
 x | @ 2 days
 y | @ 1 day
 z | @ 31 days
(4 rows)

SELECT * FROM test_sw_interval_sum ORDER BY k;
 k |    sum    
---+-----------
 x | @ 66 days
 y | @ 1 day
 z | @ 31 days
(3 rows)

DROP CONTINUOUS VIEW test_sw_int8_sum;
DROP CONTINUOUS VIEW test_sw_int4_sum;
DROP CONTINUOUS VIEW test_sw_int2_sum;
DROP CONTINUOUS VIEW test_sw_cash_sum;
DROP CONTINUOUS VIEW test_sw_float8_sum;
DROP CONTINUOUS VIEW test_sw_float4_sum;
DROP CONTINUOUS VIEW test_sw_numeric_sum;
DROP CONTINUOUS VIEW test_sw_interval_sum;

machine:
  pre:
    # Use GCC and G++ 4.9
    - sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-4.9 20
    - sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-4.9 20

dependencies:
  pre:
    - sudo apt-get update
    - sudo apt-get install check
    - sudo apt-get install libncurses-dev
    - wget https://gist.githubusercontent.com/usmanm/32a54a6b0f1f29d7737f86e29f837afa/raw/2edeaccc5af03fbb4e4564ded84cfe20a4060499/install_zmq.sh
    - sudo sh install_zmq.sh

  post:
    - ./configure CFLAGS="-O0" --prefix=/home/ubuntu/pdb --enable-cassert
    - sudo pip install -r src/test/py/requirements.txt
    - make
    - make install

test:
  override:
    - make -s check

  post:
    - if [ -e "src/test/regress/regression.diffs" ]; then cat src/test/regress/regression.diffs; fi
    - if [ -e "src/test/regress/regression.diffs" ]; then cat src/test/regress/log/postmaster.log; fi
    - (! grep -A 100 -B 10 "segfault at:" src/test/regress/log/postmaster.log)
    - (! grep -A 100 -B 10 "assertion failure at:" src/test/regress/log/postmaster.log)
